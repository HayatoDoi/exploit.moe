package main

import (
	"github.com/HayatoDoi/exploit.moe/DB"
	"github.com/HayatoDoi/exploit.moe/handlers"
	"github.com/HayatoDoi/exploit.moe/lib/md2article"
	"github.com/kataras/iris"
	"github.com/kataras/iris/mvc"
)

func main() {
	app := iris.New()

	app.StaticWeb("/assets", "assets") //debug only
	view := iris.HTML("views", ".html")
	view.Layout("_layouts/layout.html")
	app.RegisterView(view)

	// Database
	articleDB := DB.ArticleDBNew()
	arts, err := md2article.LoadDir("resource/_posts")
	if err != nil {
		panic(err)
	}
	for i := 0; i < len(arts); i++ {
		articleDB.Insert(arts[i].Filename, arts[i].Art)
	}

	// 404 error page
	app.OnErrorCode(iris.StatusNotFound, func(ctx iris.Context) {
		ctx.ViewData("Title", "404")
		ctx.View("error/404.html")
	})
	// 500 error page
	app.OnErrorCode(iris.StatusInternalServerError, func(ctx iris.Context) {
		ctx.ViewData("Title", "500")
		ctx.View("error/500.html")
	})

	mvc.New(app.Party("/")).Register(articleDB).Handle(&handlers.Top{})
	mvc.New(app.Party("/article")).Register(articleDB).Handle(&handlers.Article{})
	mvc.New(app.Party("/about.html")).Handle(&handlers.About{})

	app.Run(iris.Addr(":5000"))
}
